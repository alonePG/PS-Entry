<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PS-Entry - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <audio id="successSound" preload="auto">
    <source src="https://media.vocaroo.com/mp3/16O6YCTv88bJ" type="audio/mp3" />
  </audio>

  <!-- ‡∏™‡πÑ‡∏ï‡∏•‡πå -->
  <style>
    body {
      background: #f4f4f4;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 420px;
      margin: auto;
      padding: 1rem;
      background: white;
      border-radius: 1rem;
      margin-top: 1rem;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }
    .logo {
      max-width: 100px;
      margin-bottom: 1rem;
    }
    .form-control, .form-select {
      margin-bottom: 1rem;
    }
    #statusMsg {
      margin-top: 1rem;
    }
    #preview1, #preview2 {
      width: 100%;
      margin-bottom: 1rem;
      border: 1px solid #ccc;
      border-radius: 0.5rem;
    }
    #offlineInfo {
      margin-top: 1rem;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="text-center">
      <img src="https://i.imgur.com/QEBYa5H.png" class="logo" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô" />
      <h4>PS-Entry - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤</h4>
    </div>

    <form id="entryForm">
      <label for="plate" class="form-label">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
      <input type="text" id="plate" class="form-control" required />

      <label for="house" class="form-label">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
      <select id="house" class="form-select" required>
        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
      </select>

      <label for="purpose" class="form-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
      <select id="purpose" class="form-select" required>
        <option value="‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</option>
        <option value="‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á">‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á</option>
        <option value="‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á">‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</option>
        <option value="‡∏≠‡∏∑‡πà‡∏ô ‡πÜ">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
      </select>
      <input type="text" id="otherPurpose" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" style="display:none;" />

      <label for="note" class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
      <textarea id="note" class="form-control" rows="2"></textarea>

      <label class="form-label">‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ï‡∏£‡∏ú‡∏π‡πâ‡∏°‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
      <input type="file" id="imgID" class="form-control" accept="image/*" capture="environment" />
      <img id="preview1" style="display:none;" />

      <label class="form-label">‡∏£‡∏π‡∏õ‡∏£‡∏ñ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤</label>
      <input type="file" id="imgCar" class="form-control" accept="image/*" capture="environment" />
      <img id="preview2" style="display:none;" />

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="skipPhoto" />
        <label class="form-check-label" for="skipPhoto">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ</label>
      </div>
      <input type="text" id="skipReason" class="form-control" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û)" style="display:none;" />

      <button type="submit" class="btn btn-success w-100 mt-3">üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </form>

    <div id="statusMsg"></div>

    <div id="offlineInfo" class="alert alert-warning text-center d-none mt-3 p-2 small">
      üîå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï! ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß<br>
      <span id="offlineCount">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏™‡πà‡∏á
      <button onclick="trySyncOffline()" class="btn btn-sm btn-outline-dark mt-1">üì§ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
    </div>
  </div>
<script>
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycby_uIYRgKMVaystvuLQbWxRtiWWJrbUIFA7KDjpyFYQv3N6erfjeqnB0hv6dOw4dwYN/exec";
  const RANGER_NAME = "‡πÅ‡∏û‡πá‡∏Ñ";

  const form = document.getElementById("entryForm");
  const purpose = document.getElementById("purpose");
  const otherPurpose = document.getElementById("otherPurpose");
  const successSound = document.getElementById("successSound");
  const statusMsg = document.getElementById("statusMsg");
  const skipPhoto = document.getElementById("skipPhoto");
  const skipReason = document.getElementById("skipReason");
  const imgID = document.getElementById("imgID");
  const imgCar = document.getElementById("imgCar");
  const preview1 = document.getElementById("preview1");
  const preview2 = document.getElementById("preview2");
  const submitBtn = form.querySelector("button[type='submit']");

  purpose.addEventListener("change", () => {
    otherPurpose.style.display = purpose.value === "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ" ? "block" : "none";
  });
  skipPhoto.addEventListener("change", () => {
    skipReason.style.display = skipPhoto.checked ? "block" : "none";
  });

  async function loadHouseOptions() {
    const houseSelect = document.getElementById("house");
    try {
      const res = await fetch(`${SHEET_API_URL}?action=houses`);
      const data = await res.json();
      data.forEach(item => {
        const option = document.createElement("option");
        option.value = item;
        option.textContent = item;
        houseSelect.appendChild(option);
      });
    } catch {
      console.warn("‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }
  }
  loadHouseOptions();

  imgID.addEventListener("change", (e) => previewImage(e.target, preview1));
  imgCar.addEventListener("change", (e) => previewImage(e.target, preview2));
  function previewImage(input, target) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      target.src = reader.result;
      target.style.display = "block";
    };
    reader.readAsDataURL(file);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;

    const plate = document.getElementById("plate").value.trim();
    const house = document.getElementById("house").value.trim();
    const purposeVal = purpose.value === "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ" ? otherPurpose.value.trim() : purpose.value;
    const note = document.getElementById("note").value.trim();
    const skip = skipPhoto.checked;
    const reason = skipReason.value.trim();

    if (!plate || !house || !purposeVal) {
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      submitBtn.disabled = false;
      return;
    }
    if (skip && !reason) {
      alert("‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û");
      submitBtn.disabled = false;
      return;
    }

    statusMsg.innerHTML = `<div class="alert alert-info">üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</div>`;

    const payload = {
      plate, house, purpose: purposeVal, note,
      ranger: RANGER_NAME,
      skipPhoto: skip,
      skipReason: reason,
      imgID: "", // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û‡πÉ‡∏ô offline
      imgCar: ""
    };

    if (navigator.onLine) {
      try {
        const res = await fetch(SHEET_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await res.text();
        const isError = result.startsWith("üö´") || result.startsWith("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");

        statusMsg.innerHTML = `<div class='alert alert-${isError ? "danger" : "success"}'>${result}</div>`;

        if (!isError) {
          successSound.play().catch(() => {});
          localStorage.setItem("lastEntryData", JSON.stringify({
            plate, house, purpose: purposeVal, note,
            ranger: RANGER_NAME,
            time: new Date().toLocaleString("th-TH")
          }));
          setTimeout(() => {
            const wantPrint = confirm("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡∏ï‡∏£‡∏≤‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");
            if (wantPrint) {
              window.open(`print.html?plate=${encodeURIComponent(plate)}`, "_blank");
            } else {
              window.location.href = "dashboard.html";
            }
          }, 500);
        } else {
          submitBtn.disabled = false;
        }
      } catch (err) {
        statusMsg.innerHTML = `<div class='alert alert-danger'>‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}</div>`;
        submitBtn.disabled = false;
      }
    } else {
      saveOffline(payload);
      alert("üì¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß");
      statusMsg.innerHTML = `<div class='alert alert-warning'>üì• ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (offline)</div>`;
      updateOfflineInfo();
      submitBtn.disabled = false;
    }
  });

  function saveOffline(data) {
    const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
    data._timestamp = new Date().toISOString();
    queue.push(data);
    localStorage.setItem("offlineQueue", JSON.stringify(queue));
    updateOfflineInfo(queue.length);
  }

  async function trySyncOffline() {
    if (!navigator.onLine) {
      updateOfflineInfo();
      return;
    }
    let queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
    if (queue.length === 0) {
      updateOfflineInfo(0);
      return;
    }

    const failed = [];
    for (let item of queue) {
      try {
        const res = await fetch(SHEET_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(item)
        });
        const result = await res.text();
        if (result.startsWith("üö´") || result.startsWith("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î")) {
          failed.push(item);
        }
      } catch {
        failed.push(item);
      }
    }

    localStorage.setItem("offlineQueue", JSON.stringify(failed));
    updateOfflineInfo(failed.length);
    if (queue.length !== failed.length) {
      alert(`üì§ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${queue.length - failed.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
    }
  }

  function updateOfflineInfo(count) {
    const infoBox = document.getElementById("offlineInfo");
    const countSpan = document.getElementById("offlineCount");
    const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
    const current = typeof count === "number" ? count : queue.length;

    if (current > 0 || !navigator.onLine) {
      infoBox.classList.remove("d-none");
      countSpan.textContent = current;
    } else {
      infoBox.classList.add("d-none");
    }
  }

  window.addEventListener("load", trySyncOffline);
  window.addEventListener("online", trySyncOffline);
</script>
</body>
</html>
